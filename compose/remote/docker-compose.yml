# ============================================================================
# MCP v7 — Remote Stack (3 Containers + 2 Init: #25-#27)
# ============================================================================
# Guacamole Init (Schema-SQL generieren + anwenden), MeshCentral, Guacamole, Guacd
# ============================================================================

# Shared logging config (YAML anchor)
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

services:

  # --------------------------------------------------------------------------
  # Guacamole DB Init (one-shot — generiert Schema-SQL aus Guacamole-Image)
  # --------------------------------------------------------------------------
  guacamole-init:
    image: guacamole/guacamole:${GUACAMOLE_TAG:-1.5.5}
    container_name: mcp-guacamole-init
    restart: "no"
    networks:
      - mcp-data-net
    volumes:
      - mcp-guacamole-initdb:/initdb
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "Generiere Guacamole DB-Schema..."
        /opt/guacamole/bin/initdb.sh --postgresql > /initdb/initdb.sql
        echo "Schema SQL generiert ($$(wc -l < /initdb/initdb.sql) Zeilen)"
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
    logging: *default-logging
    security_opt:
      - no-new-privileges:true

  # --------------------------------------------------------------------------
  # Guacamole Schema Apply (one-shot — wendet SQL auf PostgreSQL an)
  # --------------------------------------------------------------------------
  guacamole-schema:
    image: postgres:${POSTGRES_TAG:-16-alpine}
    container_name: mcp-guacamole-schema
    restart: "no"
    networks:
      - mcp-data-net
    environment:
      PGPASSWORD: ${GUACAMOLE_DB_PASSWORD}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Warte auf PostgreSQL..."
        until pg_isready -h postgres -p 5432 -U ${GUACAMOLE_DB_USER:-guacamole}; do sleep 2; done
        if psql -h postgres -U ${GUACAMOLE_DB_USER:-guacamole} -d ${GUACAMOLE_DB_NAME:-guacamole} -c "SELECT 1 FROM guacamole_user LIMIT 1" >/dev/null 2>&1; then
          echo "Guacamole-Schema existiert bereits — ueberspringe"
        else
          echo "Wende Guacamole-Schema an..."
          psql -h postgres -U ${GUACAMOLE_DB_USER:-guacamole} -d ${GUACAMOLE_DB_NAME:-guacamole} -f /initdb/initdb.sql
          echo "Guacamole DB-Schema erfolgreich initialisiert"
        fi
    volumes:
      - mcp-guacamole-initdb:/initdb:ro
    depends_on:
      guacamole-init:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
    logging: *default-logging
    security_opt:
      - no-new-privileges:true

  # --------------------------------------------------------------------------
  # #25 — MeshCentral (Remote Desktop & Management)
  # RULE: Image from GHCR, not Docker Hub (Tipps.md #2)
  # RULE: Uses HTTPS internally (Tipps.md #17)
  # --------------------------------------------------------------------------
  meshcentral:
    image: ghcr.io/ylianst/meshcentral:${MESHCENTRAL_TAG:-latest}
    container_name: mcp-meshcentral
    restart: unless-stopped
    networks:
      - mcp-app-net
    expose:
      - "443"
    volumes:
      - mcp-meshcentral-data:/opt/meshcentral/meshcentral-data
    healthcheck:
      test: ["CMD-SHELL", "curl -ksf https://127.0.0.1:443/ > /dev/null"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    logging: *default-logging
    security_opt:
      - no-new-privileges:true

  # --------------------------------------------------------------------------
  # #26 — Guacamole (Web-based Remote Access)
  # RULE: Context path is /guacamole/ not / (Tipps.md #16)
  # --------------------------------------------------------------------------
  guacamole:
    image: guacamole/guacamole:${GUACAMOLE_TAG:-1.5.5}
    container_name: mcp-guacamole
    restart: unless-stopped
    networks:
      - mcp-app-net
      - mcp-data-net
    expose:
      - "8080"
    environment:
      GUACD_HOSTNAME: guacd
      GUACD_PORT: 4822
      POSTGRESQL_HOSTNAME: postgres
      POSTGRESQL_PORT: 5432
      POSTGRESQL_DATABASE: ${GUACAMOLE_DB_NAME}
      POSTGRESQL_USER: ${GUACAMOLE_DB_USER}
      POSTGRESQL_PASSWORD: ${GUACAMOLE_DB_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:8080/guacamole/ > /dev/null"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    depends_on:
      guacd:
        condition: service_healthy
      guacamole-schema:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
    logging: *default-logging
    security_opt:
      - no-new-privileges:true

  # --------------------------------------------------------------------------
  # #27 — Guacd (Guacamole Proxy Daemon)
  # --------------------------------------------------------------------------
  guacd:
    image: guacamole/guacd:${GUACD_TAG:-1.5.5}
    container_name: mcp-guacd
    restart: unless-stopped
    networks:
      - mcp-app-net
    expose:
      - "4822"
    volumes:
      - mcp-guacamole-data:/drive
    healthcheck:
      test: ["CMD-SHELL", "echo > /dev/tcp/127.0.0.1/4822"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    logging: *default-logging
    security_opt:
      - no-new-privileges:true

# ============================================================================
# Networks
# ============================================================================
networks:
  mcp-app-net:
    external: true
  mcp-data-net:
    external: true

# ============================================================================
# Volumes
# ============================================================================
volumes:
  mcp-meshcentral-data:
    external: true
  mcp-guacamole-data:
    external: true
  mcp-guacamole-initdb:
    external: true
